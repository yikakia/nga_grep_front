<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Series Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-timezone"></script>

</head>
<body class="bg-gray-100">
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">大时代景气指数(NGA:706)</h1>

    <div class="flex space-x-4 mb-4">
        <div>
            <label for="startDate" class="block text-gray-700 text-sm font-bold mb-2">开始时间范围:</label>
            <input type="datetime-local" id="startDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        <div>
            <label for="endDate" class="block text-gray-700 text-sm font-bold mb-2">结束时间范围:</label>
            <input type="datetime-local" id="endDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        <div>
            <button id="fetchData" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">查询</button>
        </div>
    </div>

    <canvas id="timeSeriesChart" aria-label="Time Series Chart" role="img"></canvas>
</div>

<script>
    const ctx = document.getElementById('timeSeriesChart').getContext('2d');
    let chart; // Declare chart variable in the outer scope

    function toUTC(dateString) {
        const localMoment = moment(dateString);
        return localMoment.utc().format('YYYY-MM-DD HH:mm');
    }

    function fromUTC(utcTimestamp) {
        return moment.utc(utcTimestamp).local().format('YYYY-MM-DD HH:mm');
    }

    function fetchData(startDateUTC, endDateUTC) {
        const apiUrl = `http://nga_grep.yikakia.com/api/timeseries?startDate=${startDateUTC}&endDate=${endDateUTC}`;


        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const labels = data.map(item => fromUTC(item.timestamp));
                const values = data.map(item => item.value);

                updateChart(labels, values);
            })
            .catch(error => {
                console.error("Error fetching data:", error);
                alert("Failed to fetch data. Check console for details.");
            });
    }

    function updateChart(labels, values) {
        if (chart) {
            chart.destroy(); // Destroy the existing chart instance
        }

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Value',
                    data: values,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'category',
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                }
            }
        });
    }


    document.addEventListener('DOMContentLoaded', () => {
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const fetchDataButton = document.getElementById('fetchData');

        // Set default date range to last 200 minutes
        const now = moment();
        const twoHundredMinutesAgo = moment().subtract(200, 'minutes');

        startDateInput.value = twoHundredMinutesAgo.format('YYYY-MM-DDTHH:mm');
        endDateInput.value = now.format('YYYY-MM-DDTHH:mm');


        fetchDataButton.addEventListener('click', () => {
            const startDateLocal = startDateInput.value;
            const endDateLocal = endDateInput.value;

            const startDateUTC = toUTC(startDateLocal);
            const endDateUTC = toUTC(endDateLocal);

            fetchData(startDateUTC, endDateUTC);
        });

        // Initial fetch with default dates
        const initialStartDateLocal = startDateInput.value;
        const initialEndDateLocal = endDateInput.value;

        const initialStartDateUTC = toUTC(initialStartDateLocal);
        const initialEndDateUTC = toUTC(initialEndDateLocal);

        fetchData(initialStartDateUTC, initialEndDateUTC);

    });
</script>
</body>
</html>
